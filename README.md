# ğŸ¦ OpenClaw â€” Personal AI Assistant

  åŸºäºæˆ‘å¯¹ä»£ç çš„åˆ†æï¼Œè¿™ä¸ª OpenClaw é¡¹ç›®æ˜¯ä¸€ä¸ªä¸ªäºº AI
  åŠ©æ‰‹ç³»ç»Ÿï¼Œå…¶æ ¸å¿ƒçš„"è§„åˆ’-æ‰§è¡Œ-è§‚å¯Ÿ"æ¨¡å¼ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªå…³é”®ç»„ä»¶ä¸­ï¼š

  æ ¸å¿ƒæ¶æ„æ¦‚è§ˆ

  1. ä¸»æ‰§è¡Œå¾ªç¯ (src/agents/pi-embedded-runner/run.ts:308)

  è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒ agentic å¾ªç¯ï¼š
```
  while (true) {
    attemptedThinking.add(thinkLevel);
    await fs.mkdir(resolvedWorkspace, { recursive: true });

    const attempt = await runEmbeddedAttempt({
      // ... æ‰§è¡Œå‚æ•°
    });

    const { aborted, promptError, timedOut, sessionIdUsed, lastAssistant } =
  attempt;

    // è§‚å¯Ÿç»“æœå¹¶å†³å®šä¸‹ä¸€æ­¥
    if (promptError && !aborted) {
      // é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘
    }

    // æ ¹æ®è§‚å¯Ÿç»“æœå†³å®šæ˜¯å¦ç»§ç»­å¾ªç¯
  }
```
  å…³é”®ç‰¹ç‚¹ï¼š
  - æ— é™å¾ªç¯ç›´åˆ°ä»»åŠ¡å®Œæˆæˆ–é‡åˆ°ä¸å¯æ¢å¤çš„é”™è¯¯
  - æ¯æ¬¡è¿­ä»£éƒ½æ˜¯ä¸€ä¸ªå®Œæ•´çš„"è®¡åˆ’-æ‰§è¡Œ-è§‚å¯Ÿ"å‘¨æœŸ
  - æ”¯æŒè‡ªåŠ¨é‡è¯•ã€é™çº§å’Œæ•…éšœè½¬ç§»

  2. æ‰§è¡Œå±‚ (src/agents/pi-embedded-runner/run/attempt.ts)

  è¿™ä¸ªæ–‡ä»¶åŒ…å«å•æ¬¡æ‰§è¡Œå°è¯•çš„æ ¸å¿ƒé€»è¾‘ï¼Œå¤„ç†ï¼š
  - å·¥å…·è°ƒç”¨æ‰§è¡Œ
  - æµå¼å“åº”å¤„ç†
  - é”™è¯¯æ•è·å’Œåˆ†ç±»

  3. è§‚å¯Ÿå’ŒçŠ¶æ€ç®¡ç† (src/agents/pi-embedded-subscribe.ts)

  è¿™ä¸ªè®¢é˜…ç³»ç»Ÿè´Ÿè´£è§‚å¯Ÿ AI ä»£ç†çš„æ‰§è¡Œè¿‡ç¨‹ï¼š
```
  const state: EmbeddedPiSubscribeState = {
    assistantTexts: [],        // æ”¶é›†åŠ©æ‰‹çš„æ–‡æœ¬è¾“å‡º
    toolMetas: [],             // å·¥å…·æ‰§è¡Œçš„å…ƒæ•°æ®
    toolMetaById: new Map(),   // å·¥å…·è°ƒç”¨è¿½è¸ª
    lastToolError: undefined,  // æœ€åçš„å·¥å…·é”™è¯¯
    // ... æ›´å¤šçŠ¶æ€
  };
```
  è§‚å¯Ÿçš„å†…å®¹åŒ…æ‹¬ï¼š
  - åŠ©æ‰‹çš„æ–‡æœ¬è¾“å‡ºï¼ˆæµå¼å’Œå®Œæ•´ï¼‰
  - å·¥å…·è°ƒç”¨å’Œç»“æœ
  - æ¨ç†è¿‡ç¨‹ï¼ˆthinking blocksï¼‰
  - é”™è¯¯å’Œå¼‚å¸¸

  4. æ™ºèƒ½é‡è¯•å’Œæ•…éšœè½¬ç§»æœºåˆ¶

  ç³»ç»Ÿå®ç°äº†å¤æ‚çš„è§‚å¯Ÿ-ååº”æœºåˆ¶ï¼š

  ä¸Šä¸‹æ–‡æº¢å‡ºå¤„ç† (run.ts:374-409)ï¼š
```
  if (isContextOverflowError(errorText)) {
    if (!isCompactionFailure && !overflowCompactionAttempted) {
      log.warn(`context overflow detected; attempting auto-compaction`);
      overflowCompactionAttempted = true;
      const compactResult = await compactEmbeddedPiSessionDirect({...});
      if (compactResult.compacted) {
        log.info(`auto-compaction succeeded; retrying prompt`);
        continue; // é‡æ–°æ‰§è¡Œ
      }
    }
  }
```
  è®¤è¯é…ç½®æ–‡ä»¶è½®æ¢ (run.ts:249-274)ï¼š
 ```
  const advanceAuthProfile = async (): Promise<boolean> => {
    if (lockedProfileId) return false;

    let nextIndex = profileIndex + 1;
    while (nextIndex < profileCandidates.length) {
      const candidate = profileCandidates[nextIndex];
      if (candidate && isProfileInCooldown(authStore, candidate)) {
        nextIndex += 1;
        continue;
      }
      // å°è¯•ä¸‹ä¸€ä¸ªè®¤è¯é…ç½®
      await applyApiKeyInfo(candidate);
      profileIndex = nextIndex;
      return true;
    }
    return false;
  };
```
  æ€ç»´çº§åˆ«é™çº§ (run.ts:500-509)ï¼š
```
  const fallbackThinking = pickFallbackThinkingLevel({
    message: errorText,
    attempted: attemptedThinking,
  });
  if (fallbackThinking) {
    log.warn(`unsupported thinking level; retrying with ${fallbackThinking}`);
    thinkLevel = fallbackThinking;
    continue; // ç”¨æ–°çš„æ€ç»´çº§åˆ«é‡è¯•
  }
```
  5. å·¥å…·ç³»ç»Ÿ (src/agents/tools/)

  å·¥å…·æ˜¯æ‰§è¡Œé˜¶æ®µçš„æ ¸å¿ƒç»„ä»¶ï¼ŒåŒ…æ‹¬ï¼š
  - bash-tools.exec.ts - Bash å‘½ä»¤æ‰§è¡Œï¼ˆ52KBï¼Œæœ€å¤§çš„å·¥å…·æ–‡ä»¶ï¼‰
  - browser-tool.ts - æµè§ˆå™¨è‡ªåŠ¨åŒ–
  - message-tool.ts - æ¶ˆæ¯å‘é€
  - web-search.ts / web-fetch.ts - ç½‘ç»œæœç´¢å’ŒæŠ“å–
  - sessions-send-tool.a2a.ts - Agent-to-Agent é€šä¿¡

  6. ä¼šè¯ç®¡ç†å’Œå†å² (src/agents/pi-embedded-helpers/turns.ts)

  ç®¡ç†å¯¹è¯è½®æ¬¡ï¼Œç¡®ä¿æ­£ç¡®çš„ç”¨æˆ·-åŠ©æ‰‹äº¤æ›¿æ¨¡å¼ï¼š
  - validateGeminiTurns() - Gemini API çš„ä¸¥æ ¼äº¤æ›¿æ¨¡å¼
  - validateAnthropicTurns() - Anthropic API çš„ç”¨æˆ·-åŠ©æ‰‹æ¨¡å¼
  - mergeConsecutiveUserTurns() - åˆå¹¶è¿ç»­çš„ç”¨æˆ·æ¶ˆæ¯

  å®Œæ•´çš„è§„åˆ’-æ‰§è¡Œ-è§‚å¯Ÿæµç¨‹
```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 1. è§„åˆ’é˜¶æ®µ (Planning)                                       â”‚
  â”‚    - æ¥æ”¶ç”¨æˆ·è¾“å…¥                                             â”‚
  â”‚    - é€‰æ‹©æ¨¡å‹å’Œè®¤è¯é…ç½®                                       â”‚
  â”‚    - å‡†å¤‡ç³»ç»Ÿæç¤ºå’Œä¸Šä¸‹æ–‡                                     â”‚
  â”‚    - è®¾ç½®å·¥å…·å’Œæƒé™                                           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 2. æ‰§è¡Œé˜¶æ®µ (Execution)                                      â”‚
  â”‚    - runEmbeddedAttempt() å‘é€è¯·æ±‚åˆ° LLM                    â”‚
  â”‚    - æµå¼æ¥æ”¶å“åº”                                             â”‚
  â”‚    - æ‰§è¡Œå·¥å…·è°ƒç”¨ (Bash, Browser, WebSearch, etc.)          â”‚
  â”‚    - æ”¶é›†è¾“å‡ºå’Œå…ƒæ•°æ®                                         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 3. è§‚å¯Ÿé˜¶æ®µ (Observation)                                    â”‚
  â”‚    - subscribeEmbeddedPiSession() ç›‘æ§æ‰§è¡Œ                   â”‚
  â”‚    - æ£€æµ‹é”™è¯¯ç±»å‹ (context overflow, auth failure, etc.)    â”‚
  â”‚    - åˆ†æ stopReason å’Œå·¥å…·ç»“æœ                              â”‚
  â”‚    - è®°å½•ä½¿ç”¨æƒ…å†µå’Œæ€§èƒ½æŒ‡æ ‡                                   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 4. å†³ç­–é˜¶æ®µ (Decision)                                       â”‚
  â”‚    - æˆåŠŸï¼Ÿâ†’ è¿”å›ç»“æœ                                         â”‚
  â”‚    - ä¸Šä¸‹æ–‡æº¢å‡ºï¼Ÿâ†’ å‹ç¼©ä¼šè¯å¹¶é‡è¯•                             â”‚
  â”‚    - è®¤è¯å¤±è´¥ï¼Ÿâ†’ åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªé…ç½®æ–‡ä»¶                         â”‚
  â”‚    - é€Ÿç‡é™åˆ¶ï¼Ÿâ†’ æ ‡è®°é…ç½®æ–‡ä»¶å†·å´å¹¶è½®æ¢                       â”‚
  â”‚    - ä¸æ”¯æŒçš„åŠŸèƒ½ï¼Ÿâ†’ é™çº§å‚æ•°å¹¶é‡è¯•                           â”‚
  â”‚    - è¶…æ—¶ï¼Ÿâ†’ æ ‡è®°å¤±è´¥å¹¶å°è¯•æ•…éšœè½¬ç§»                           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                      (å¾ªç¯å›åˆ°æ‰§è¡Œé˜¶æ®µ)
```
  å…³é”®æ–‡ä»¶æ€»ç»“
  æ–‡ä»¶è·¯å¾„: src/agents/pi-embedded-runner/run.ts
  èŒè´£: ä¸»æ‰§è¡Œå¾ªç¯å’Œé‡è¯•é€»è¾‘
  ä»£ç è¡Œæ•°: ~693 è¡Œ
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  æ–‡ä»¶è·¯å¾„: src/agents/pi-embedded-runner/run/attempt.ts
  èŒè´£: å•æ¬¡æ‰§è¡Œå°è¯•
  ä»£ç è¡Œæ•°: ~34KB
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  æ–‡ä»¶è·¯å¾„: src/agents/pi-embedded-subscribe.ts
  èŒè´£: æµå¼è§‚å¯Ÿå’ŒçŠ¶æ€ç®¡ç†
  ä»£ç è¡Œæ•°: å¤§å‹æ–‡ä»¶
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  æ–‡ä»¶è·¯å¾„: src/agents/bash-tools.exec.ts
  èŒè´£: Bash å·¥å…·æ‰§è¡Œ
  ä»£ç è¡Œæ•°: ~52KB
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  æ–‡ä»¶è·¯å¾„: src/agents/pi-embedded-helpers/turns.ts
  èŒè´£: å¯¹è¯è½®æ¬¡éªŒè¯
  ä»£ç è¡Œæ•°: ~120 è¡Œ
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  æ–‡ä»¶è·¯å¾„: src/agents/tool-policy.ts
  èŒè´£: å·¥å…·æƒé™ç­–ç•¥
  ä»£ç è¡Œæ•°: -
  è¿™ä¸ªç³»ç»Ÿå±•ç¤ºäº†ä¸€ä¸ªæˆç†Ÿçš„ agentic
  æ¶æ„ï¼Œå…·æœ‰å¼ºå¤§çš„é”™è¯¯æ¢å¤ã€è‡ªé€‚åº”é‡è¯•å’Œå¤šå±‚æ•…éšœè½¬ç§»èƒ½åŠ›ã€‚
